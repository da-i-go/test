<!DOCTYPE html>
<html lang="ja">
  <head>
  	<meta name="robots" content="noindex, nofollow" />
  	<meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STATç”»åƒå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="css/test-zoom1.css" rel="stylesheet" />
    
    <!--
    <script>
      // æœªèªè¨¼ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã¸
      if (sessionStorage.getItem("authenticated") !== "true") {
        location.replace("index.html");
      } 
    </script>-->
  </head>

  <body>
  	<div id="loadingOverlay">
  		<div class="spinner"></div>
  		<div class="loading-text">Loading...</div>
    </div>

    <main style="display: none">
      <h1 id="setTitle">æ¤œæŸ»ç”»åƒ</h1>
      
      <div class="set-buttons" id="setButtonsContainer"></div>

      <div class="viewer">
      	<img alt="CT Slice" id="ctImage" src="" />
      </div>
      
      <!-- â–¼ ã“ã“ã‹ã‚‰ï¼šæ‹¡å¤§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆé…ç½®ã®ã¿ã€‚æ©Ÿèƒ½ã¯å¾Œã§å®Ÿè£…ï¼‰ -->
      <div class="zoom-controls" aria-label="ã‚ºãƒ¼ãƒ æ“ä½œ">
      	<button type="button" id="zoomOutBtn" class="zoom-button" aria-label="ç¸®å°">ğŸ”ï¼</button>
        <span id="zoomLevel" class="zoom-level" aria-live="polite" aria-atomic="true">100%</span>
        <button type="button" id="zoomInBtn" class="zoom-button" aria-label="æ‹¡å¤§">ğŸ”ï¼‹</button>
      </div>
      
      
      <div class="slider-container">
        <button class="arrow-button" onclick="changeSlice(-1)">â†</button>
        <input
          id="sliceSlider"
          min="1"
          step="1"
          type="range"
          oninput="updateSlice(parseInt(this.value))"
        />
        <button class="arrow-button" onclick="changeSlice(1)">â†’</button>
      </div>

      <div class="slice-info" id="sliceInfo">ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ã‚¹: 1</div>

      <div class="navigation">
        <button onclick="location.href='answer3-1.html'">
          <span class="icon">â–¶</span>
          <span class="label">è§£ç­”</span>
        </button>
      </div>
    </main>

    <script>
      const imageSets = {
        "Xp": { label: "ãƒ¬ãƒ³ãƒˆã‚²ãƒ³", totalSlices: 1, padding: 5 },
        "CT-tra": { label: "é€ å½±CT", totalSlices: 96, padding: 5 },
        "CT-lung": { label: "CTè‚º", totalSlices: 79, padding: 5 },
        "CT-cor": { label: "corç”»åƒ", totalSlices: 96, padding: 5 },
      };

      let currentSet = "Xp"; // â† ã“ã“ã‚’å¤‰ãˆã‚‹ã®ã‚’å¿˜ã‚Œãªã„
      let currentSlice = 1;
      const imageCache = {};

      const ctImage = document.getElementById("ctImage");
      const slider = document.getElementById("sliceSlider");
      const info = document.getElementById("sliceInfo");
      const title = document.getElementById("setTitle");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const mainContent = document.querySelector("main");
      const setButtonsContainer = document.getElementById("setButtonsContainer");

      function getImageFilename(n, set = currentSet) {
        const padding = imageSets[set].padding || 0;
        const padded = String(n).padStart(padding, "0");
        return `${set}/${set}-${padded}.JPG`;
      }

      function preloadImages(set, callback) {
        if (imageCache[set]) {
          callback();
          return;
        }

        const { totalSlices } = imageSets[set];
        imageCache[set] = [];
        let loaded = 0;

        for (let i = 1; i <= totalSlices; i++) {
          const img = new Image();
          img.onload = img.onerror = () => {
            loaded++;
            if (loaded === totalSlices) callback();
          };
          img.src = getImageFilename(i, set);
          imageCache[set][i] = img;
        }
      }

      function updateSlice(n) {
        const total = imageSets[currentSet].totalSlices;
        currentSlice = n;
        const img = imageCache[currentSet]?.[n];
        ctImage.src = img?.src || getImageFilename(n);
        info.textContent = `ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ã‚¹: ${n} / ${total}`;
        slider.value = n;
      }

      function changeSlice(step) {
        const total = imageSets[currentSet].totalSlices;
        const newSlice = Math.max(1, Math.min(total, currentSlice + step));
        updateSlice(newSlice);
      }

      function switchImageSetTo(setName) {
        loadingOverlay.style.display = "flex";
        mainContent.style.display = "none";

        currentSet = setName;
        currentSlice = 1;

        slider.max = imageSets[setName].totalSlices;
        slider.value = currentSlice;

        preloadImages(currentSet, () => {
          loadingOverlay.style.display = "none";
          mainContent.style.display = "flex";
          updateSlice(currentSlice);
          updateButtonStates();
        });
      }

      function createSetButtons() {
        for (const key in imageSets) {
          const btn = document.createElement("button");
          btn.textContent = imageSets[key].label;
          btn.className = "set-button";
          btn.dataset.setKey = key;
          btn.addEventListener("click", () => switchImageSetTo(key));
          setButtonsContainer.appendChild(btn);
        }
      }

      function updateButtonStates() {
        const buttons = setButtonsContainer.querySelectorAll(".set-button");
        buttons.forEach((btn) => {
          const key = btn.dataset.setKey;
          if (key === currentSet) {
            btn.disabled = true;
            btn.innerHTML = `âœ”ï¸ ${imageSets[key].label}`;
          } else {
            btn.disabled = false;
            btn.innerHTML = imageSets[key].label;
          }
        });
      }
      

/* === ã‚ºãƒ¼ãƒ ï¼†æŠ¼ã—ã¦ã„ã‚‹é–“ã ã‘ãƒ‰ãƒ©ãƒƒã‚°ã§ãã‚‹å‡¦ç† ===================== */
let zoomScale = 1;
const MIN_ZOOM = 0.5;
const MAX_ZOOM = 4;
const STEP_ZOOM = 0.2;

let offsetX = 0;
let offsetY = 0;
let startX = 0;
let startY = 0;
let isDragging = false;

const zoomLevelEl = document.getElementById("zoomLevel");
const zoomInBtn   = document.getElementById("zoomInBtn");
const zoomOutBtn  = document.getElementById("zoomOutBtn");

function applyZoom() {
  ctImage.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${zoomScale})`;
  zoomLevelEl.textContent = `${Math.round(zoomScale * 100)}%`;
}

function setZoom(next) {
  zoomScale = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, next));
  if (zoomScale <= 1) {
    offsetX = 0;
    offsetY = 0;
  }
  applyZoom();
}

function zoomIn()  { setZoom(zoomScale + STEP_ZOOM); }
function zoomOut() { setZoom(zoomScale - STEP_ZOOM); }

function resetZoom() {
  zoomScale = 1;
  offsetX = 0;
  offsetY = 0;
  applyZoom();
}

/* === æ å¤–ã«å‡ºãªã„ã‚ˆã†ã«åˆ¶é™ ===================== */
function clampOffsets() {
  const rect = document.querySelector(".viewer").getBoundingClientRect();
  const imgWidth = rect.width * zoomScale;
  const imgHeight = rect.height * zoomScale;
  const maxX = (imgWidth - rect.width) / 2;
  const maxY = (imgHeight - rect.height) / 2;
  offsetX = Math.max(-maxX, Math.min(maxX, offsetX));
  offsetY = Math.max(-maxY, Math.min(maxY, offsetY));
}

/* === PCãƒ‰ãƒ©ãƒƒã‚°æ“ä½œï¼ˆæŠ¼ã—ã¦ã„ã‚‹é–“ã ã‘ï¼‰ ===================== */
/* === PCãƒ‰ãƒ©ãƒƒã‚°æ“ä½œï¼ˆæŠ¼ã—ã¦ã„ã‚‹é–“ã ã‘æ»‘ã‚‰ã‹ç§»å‹•ãƒ»ã‚ºãƒ¬é˜²æ­¢ï¼‰ === */
ctImage.addEventListener("mousedown", (e) => {
  if (zoomScale <= 1) return;
  e.preventDefault(); // â† ãƒ–ãƒ©ã‚¦ã‚¶ã®ç”»åƒãƒ‰ãƒ©ãƒƒã‚°é˜²æ­¢
  isDragging = true;
  startX = e.clientX;
  startY = e.clientY;
  ctImage.style.cursor = "grabbing";
});

window.addEventListener("mousemove", (e) => {
  if (!isDragging) return;
  e.preventDefault();

  // ç§»å‹•é‡ï¼ˆå·®åˆ†ï¼‰ã‚’è¨ˆç®—
  const dx = e.clientX - startX;
  const dy = e.clientY - startY;
  startX = e.clientX;
  startY = e.clientY;

  offsetX += dx;
  offsetY += dy;
  clampOffsets();
  applyZoom();
});

window.addEventListener("mouseup", () => {
  isDragging = false;
  ctImage.style.cursor = "grab";
});


/* === ã‚¹ãƒãƒ›ã‚¹ãƒ¯ã‚¤ãƒ—æ“ä½œï¼ˆæŠ¼ã—ã¦ã„ã‚‹é–“ã ã‘ç§»å‹•ï¼‰ === */
let lastTouchX = 0;
let lastTouchY = 0;

ctImage.addEventListener("touchstart", (e) => {
  if (zoomScale <= 1) return;
  if (e.touches.length !== 1) return;
  const t = e.touches[0];
  lastTouchX = t.clientX;
  lastTouchY = t.clientY;
});

ctImage.addEventListener("touchmove", (e) => {
  if (zoomScale <= 1) return;
  if (e.touches.length !== 1) return;
  e.preventDefault();
  const t = e.touches[0];
  const dx = t.clientX - lastTouchX;
  const dy = t.clientY - lastTouchY;
  lastTouchX = t.clientX;
  lastTouchY = t.clientY;

  offsetX += dx;
  offsetY += dy;
  clampOffsets();
  applyZoom();
});


/* === ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³ === */
zoomInBtn.addEventListener("click", zoomIn);
zoomOutBtn.addEventListener("click", zoomOut);

/* === ç”»åƒã‚»ãƒƒãƒˆåˆ‡ã‚Šæ›¿ãˆæ™‚ã«ãƒªã‚»ãƒƒãƒˆ === */
const _origSwitchSet = switchImageSetTo;
switchImageSetTo = function(setName) {
  _origSwitchSet(setName);
  resetZoom(); // â† ã‚»ãƒƒãƒˆåˆ‡ã‚Šæ›¿ãˆæ™‚ã¯å€ç‡ã‚’100%ã«
};


      window.onload = () => {
        createSetButtons();
        updateButtonStates();
        preloadImages(currentSet, () => {
          loadingOverlay.style.display = "none";
          mainContent.style.display = "flex";
          updateSlice(currentSlice);
          applyZoom(); // åˆæœŸè¡¨ç¤ºã‚’100%ã¨è¡¨ç¤ºåŒæœŸ
        });
      };
    </script>
  </body>
</html>
